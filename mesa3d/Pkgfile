# Description: Mesa 3D Graphics Library
# URL: https://www.mesa3d.org
# Maintainer: Tim Biermann, tbier at posteo dot de
# Depends on: elfutils libdrm libglvnd libvdpau llvm python3-mako xorg-libxdamage xorg-libxrandr xorg-libxshmfence xorg-libxvmc xorg-libxxf86vm
# Optional: wayland-protocols

name=mesa3d
version=20.0.4
release=1
source=(https://mesa.freedesktop.org/archive/mesa-$version.tar.xz)

build() {
  cd mesa-$version

  [[ -e '/usr/lib/pkgconfig/wayland-server.pc' ]] && PKGMK_MESA_PLATFORMS+=',wayland'

  meson build $PKGMK_MESA3D \
    --prefix=/usr \
    --sysconfdir=/etc \
    -Dllvm=true \
    -Dgbm=true \
    -Dgles1=true \
    -Dgles2=true \
    -Dosmesa=gallium \
    -Dgallium-xa=true \
    -Dgallium-vdpau=true \
    -Dshared-llvm=true \
    -Dplatforms=drm,x11$PKGMK_MESA_PLATFORMS \
    -Dgallium-drivers=r300,r600,swrast,svga,radeonsi,iris \
    -Dvulkan-drivers=amd,intel \
    -Dglvnd=true \
    -Ddri-drivers=i915 \
    -Ddri3=true

  DESTDIR=$PKG ninja -C build -j ${JOBS:-1} install
  # indirect rendering symlink
  ln -s libGLX_mesa.so.0 $PKG/usr/lib/libGLX_indirect.so.0
}
